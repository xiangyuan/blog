<!doctype html>
<html lang="en">
    <head>
        <title>Ubuntu / Redmine / Nginx / Mongrel / Supervisord</title>

        <!-- meta -->
        <meta name="author" content="Danilo Bargen">
        <meta name="dc.language" content="en-US">
        <meta name="dc.license" content="http://creativecommons.org/licenses/by-sa/3.0/">
        <meta name="description" content="How to install Redmine on Ubuntu with Nginx, Mongrel and Supervisord.">
        <meta name="keywords" content="nginx, redmine, sysadmin">
        
            <meta name="dc.date.created" content="2012-02-21">
            <meta name="dc.date.issued" content="2012-02-21">
        
        <meta name="google-site-verification" content="uJWWR6d5ESb8torD0v97T_07HLMGX7VzQ-smcUTc_IQ" />

        <!-- favicon -->
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <!-- newsfeed -->
        <link href="/feed.atom" rel="alternate" title="Feed" type="application/atom+xml">

        <!-- assets -->
        <link href="https://fonts.googleapis.com/css?family=Linden+Hill:400,400italic" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="/static/style.css?1371592067" type="text/css">
            <link rel="stylesheet" href="/static/_pygments.css?1371592069" type="text/css">
    </head>
    <body>
        <div id="wrapper">
            <div id="blogtitle"><a href="/">blog.dbrgn.ch</a></div>
            <ul id="mainnav">
                <li><a href="/">home</a></li>
                <li><a href="/archive/">archive</a></li>
                <li><a href="/tags/">tags</a></li>
                <li><a href="/blog/">about this blog</a></li>
                <li class="last"><a href="/about/">about me</a></li>
            </ul>

            <div class="clearboth"></div>

            <div id="content" class="hyphenate">
                
  <h1 class="title">Ubuntu / Redmine / Nginx / Mongrel / Supervisord</h1>

  
    <div class="date">
      <p>written on Tuesday, February 21, 2012</p>
    </div>
  

  <p>This is a howto to install Redmine on Ubuntu Natty (probably works on Debian too) with Nginx,
Mongrel and Supervisord. The listed commands usually assume root permissions.</p>
<p>Involved software:</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">Redmine:</th><td class="field-body">Duh, the software you want to install :)</td>
</tr>
<tr class="field"><th class="field-name">Nginx:</th><td class="field-body">A fast webserver/proxy from Russia</td>
</tr>
<tr class="field"><th class="field-name">Mongrel:</th><td class="field-body">The software used to serve redmine</td>
</tr>
<tr class="field"><th class="field-name">Supervisor:</th><td class="field-body">A supervisor daemon written in Python, it automatically restarts the Mongrel process in case it dies.</td>
</tr>
</tbody>
</table>
<p>First, add the PPA for the currently stable Nginx version (the Ubuntu version is outdated).</p>
<div class="highlight"><pre><span class="nv">$ </span>add-apt-repository ppa:nginx/stable
</pre></div>
<p>Then install redmine using your desired backend (e.g. <tt class="docutils literal"><span class="pre">redmine-sqlite</span></tt>), and the supervisor and nginx
packages.</p>
<div class="highlight"><pre><span class="nv">$ </span>aptitude install redmine redmine-sqlite nginx supervisor
</pre></div>
<p>Install the mongrel gem.</p>
<div class="highlight"><pre><span class="nv">$ </span>gem install mongrel
</pre></div>
<p>Set up redmine...</p>
<div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> /usr/share/redmine
<span class="nv">$ </span>touch log/production.log
<span class="nv">$ </span>chmod 777 log log/production.log
</pre></div>
<p>Then add the mongrel initializer to redmine (see <a class="reference external" href="http://www.redmine.org/boards/2/topics/24305">this bug</a>):</p>
<div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd </span>config/initializers
<span class="nv">$ </span>wget <span class="s1">&#39;https://gist.github.com/raw/826692/cb0dcf784c30e6a6d00c631f350de99ab99e389d/mongrel.rb&#39;</span>
</pre></div>
<p>Configure nginx:</p>
<div class="highlight"><pre><span class="nv">$ </span><span class="nb">cd</span> /etc/nginx/sites-enabled
<span class="nv">$ </span>touch ../sites-available/redmine
<span class="nv">$ </span>ln -s ../sites-available/redmine
<span class="nv">$ </span>vim redmine
</pre></div>
<p>Add the following configuration (adjust to your likings):</p>
<div class="highlight"><pre><span class="k">upstream</span> <span class="s">redmine_server</span> <span class="p">{</span>
        <span class="kn">server</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">3000</span> <span class="s">fail_timeout=0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">server</span> <span class="p">{</span>
        <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
        <span class="kn">server_name</span> <span class="s">domain.example.com</span><span class="p">;</span>

        <span class="kn">root</span> <span class="s">/usr/share/redmine/public</span><span class="p">;</span>

        <span class="kn">access_log</span> <span class="s">/var/log/nginx/redmine.access.log</span><span class="p">;</span>
        <span class="kn">error_log</span> <span class="s">/var/log/nginx/redmine.error.log</span> <span class="s">info</span><span class="p">;</span>

        <span class="kn">keepalive_timeout</span> <span class="mi">5</span><span class="p">;</span>

        <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
                <span class="kn">try_files</span> <span class="nv">$uri/index.html</span> <span class="nv">$uri.html</span> <span class="nv">$uri</span> <span class="s">@mongrel</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kn">location</span> <span class="s">@mongrel</span> <span class="p">{</span>
                <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
                <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
                <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
                <span class="kn">proxy_redirect</span> <span class="no">off</span><span class="p">;</span>
                <span class="kn">proxy_pass</span> <span class="s">http://redmine_server</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Then edit /etc/supervisord/supervisord.conf and add the following
program definition at the end:</p>
<div class="highlight"><pre><span class="k">[program:redmine]</span>
<span class="na">command</span><span class="o">=</span><span class="s">ruby /usr/share/redmine/script/server -e production</span>
<span class="na">directory</span><span class="o">=</span><span class="s">/usr/share/redmine/public/</span>
<span class="na">user</span><span class="o">=</span><span class="s">www-data</span>
<span class="na">autostart</span><span class="o">=</span><span class="s">true</span>
<span class="na">autorestart</span><span class="o">=</span><span class="s">true</span>
<span class="na">redirect_stderr</span><span class="o">=</span><span class="s">True</span>
</pre></div>
<p>Now restart nginx and supervisord:</p>
<div class="highlight"><pre><span class="nv">$ </span>/etc/init.d/supervisord stop
<span class="nv">$ </span>/etc/init.d/supervisord start
<span class="nv">$ </span>/etc/init.d/nginx restart
</pre></div>
<p>(The supervisord restart command is broken in current Ubuntu and Debian
versions)</p>
<p>That's it, now your redmine installation should be up and running. In
case of questions, feel free to comment.</p>


  
      <a href="https://flattr.com/submit/auto?user_id=danilo&url=http://blog.dbrgn.ch/2012/2/21/ubuntu-redmine-nginx-mongrel-supervisord/&title=Ubuntu%20/%20Redmine%20/%20Nginx%20/%20Mongrel%20/%20Supervisord&description=How%20to%20install%20Redmine%20on%20Ubuntu%20with%20Nginx%2C%20Mongrel%20and%20Supervisord.&tags=nginx%2C%20redmine%2C%20sysadmin&category=text">
           <img class="flattrbutton" src="/static/img/flattr-badge-large.png" alt="Flattr this!" /> 
      </a>
  

  
    <div class="tags">
      <p>This entry was tagged
      
        <a href="/tags/nginx/">nginx</a>, 
        <a href="/tags/redmine/">redmine</a> and 
        <a href="/tags/sysadmin/">sysadmin</a></p>
    </div>
  

  
    
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'dbrgn'; // required: replace example with your forum shortname
    
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  

            </div>
        </div>

        <script type="text/javascript">
          var _gaq = _gaq || [];
          _gaq.push(['_setAccount', 'UA-1033934-12']);
          _gaq.push(['_trackPageview']);
          (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
          })();
        </script>
        <script type="text/javascript" src="/static/hyphenator.js"></script>
        <script type="text/javascript">
            Hyphenator.config({
                donthyphenateclassname : 'docutils literal'
            });
            Hyphenator.run();
        </script>

    </body>
</html>
